name: Auto Deploy

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ø¨ÙŠØ¦Ø© Ø§Ù„Ù†Ø´Ø±'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      force_deploy:
        description: 'Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù†Ø´Ø±'
        required: false
        default: false
        type: boolean

env:
  DOTNET_VERSION: '8.0.x'
  SOLUTION_FILE: 'MedicalLabAnalyzer.sln'
  PROJECT_FILE: 'MedicalLabAnalyzer.csproj'

jobs:
  build-and-package:
    runs-on: windows-latest
    
    outputs:
      package-path: ${{ steps.package.outputs.path }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Get version
      id: version
      run: |
        $version = "1.0.0"
        if ($env:GITHUB_REF -like "refs/tags/v*") {
          $version = $env:GITHUB_REF -replace "refs/tags/v", ""
        } else {
          $version = "$version.${{ github.run_number }}"
        }
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}

    - name: Build solution
      run: dotnet build ${{ env.SOLUTION_FILE }} --configuration Release --no-restore

    - name: Run tests
      run: dotnet test ${{ env.SOLUTION_FILE }} --configuration Release --no-build --verbosity normal

    - name: Publish application
      run: |
        dotnet publish ${{ env.PROJECT_FILE }} --configuration Release --runtime win-x64 --self-contained true --output publish/win-x64 --verbosity normal

    - name: Create deployment package
      id: package
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $packageName = "MedicalLabAnalyzer_v${version}_win-x64"
        $distPath = "dist"
        $publishPath = "publish/win-x64"
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹
        New-Item -ItemType Directory -Path "$distPath/$packageName" -Force
        
        # Ù†Ø³Ø® Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©
        Copy-Item -Path "$publishPath/*" -Destination "$distPath/$packageName/" -Recurse -Force
        
        # Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©
        Copy-Item -Path "README.md" -Destination "$distPath/$packageName/" -Force
        Copy-Item -Path "INSTALLATION_GUIDE.md" -Destination "$distPath/$packageName/" -Force
        Copy-Item -Path "QUICK_START.md" -Destination "$distPath/$packageName/" -Force
        Copy-Item -Path "CHANGELOG.txt" -Destination "$distPath/$packageName/" -Force
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù appsettings.json
        @"
{
  "ConnectionStrings": {
    "DefaultConnection": "Data Source=Database/medical_lab.db"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft": "Warning",
      "Microsoft.Hosting.Lifetime": "Information"
    }
  },
  "AllowedHosts": "*",
  "Database": {
    "AutoMigrate": true,
    "SeedData": true
  },
  "Reports": {
    "OutputPath": "Reports/GeneratedReports",
    "ArchivePath": "Reports/Archive",
    "TemplatePath": "Reports/Templates"
  },
  "Security": {
    "JwtSecret": "your-super-secret-jwt-key-change-in-production",
    "JwtExpirationHours": 24
  },
  "Version": "$version",
  "BuildDate": "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')",
  "Environment": "${{ github.event.inputs.environment || 'production' }}"
}
"@ | Out-File -FilePath "$distPath/$packageName/appsettings.json" -Encoding UTF8
        
        # Ø¥Ù†Ø´Ø§Ø¡ ZIP
        Compress-Archive -Path "$distPath/$packageName/*" -DestinationPath "$distPath/${packageName}.zip" -Force
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±
        @"
MedicalLabAnalyzer v$version
Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
Commit: ${{ github.sha }}
Branch: ${{ github.ref_name }}
Environment: ${{ github.event.inputs.environment || 'production' }}
"@ | Out-File -FilePath "$distPath/${packageName}_info.txt" -Encoding UTF8
        
        echo "path=$distPath/${packageName}.zip" >> $env:GITHUB_OUTPUT
        echo "Package created: $distPath/${packageName}.zip"

    - name: Upload package
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: dist/*.zip

  deploy-to-staging:
    needs: build-and-package
    runs-on: windows-latest
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download package
      uses: actions/download-artifact@v4
      with:
        name: deployment-package
        path: staging/

    - name: Deploy to staging server
      run: |
        Write-Host "Deploying to staging environment..."
        Write-Host "Version: ${{ needs.build-and-package.outputs.version }}"
        Write-Host "Package: ${{ needs.build-and-package.outputs.package-path }}"
        
        # Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù†Ø´Ø± Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø®Ø§Ø¯Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        # Ù…Ø«Ø§Ù„: Ù†Ø³Ø® Ø§Ù„Ù…Ù„ÙØ§Øª Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ Ù…Ø´ØªØ±Ùƒ Ø£Ùˆ Ø®Ø§Ø¯Ù… FTP
        
        Write-Host "Staging deployment completed successfully!"

    - name: Notify staging deployment
      run: |
        Write-Host "âœ… Staging deployment completed!"
        Write-Host "Version: ${{ needs.build-and-package.outputs.version }}"
        Write-Host "Environment: staging"

  deploy-to-production:
    needs: build-and-package
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.environment == 'production'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download package
      uses: actions/download-artifact@v4
      with:
        name: deployment-package
        path: production/

    - name: Deploy to production server
      run: |
        Write-Host "Deploying to production environment..."
        Write-Host "Version: ${{ needs.build-and-package.outputs.version }}"
        Write-Host "Package: ${{ needs.build-and-package.outputs.package-path }}"
        
        # Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù†Ø´Ø± Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø®Ø§Ø¯Ù… Ø§Ù„Ø¥Ù†ØªØ§Ø¬
        # Ù…Ø«Ø§Ù„: Ù†Ø³Ø® Ø§Ù„Ù…Ù„ÙØ§Øª Ø¥Ù„Ù‰ Ø®Ø§Ø¯Ù… Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø£Ùˆ Ø®Ø¯Ù…Ø© Ø³Ø­Ø§Ø¨ÙŠØ©
        
        Write-Host "Production deployment completed successfully!"

    - name: Create production release
      uses: softprops/action-gh-release@v2
      with:
        files: production/*.zip
        draft: false
        prerelease: false
        generate_release_notes: true
        title: MedicalLabAnalyzer ${{ needs.build-and-package.outputs.version }}
        body: |
          ## ğŸ‰ MedicalLabAnalyzer ${{ needs.build-and-package.outputs.version }}
          
          ### ğŸš€ ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ù†ØªØ§Ø¬
          - âœ… Ø¨Ù†Ø§Ø¡ Ù†Ø§Ø¬Ø­
          - âœ… Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©
          - âœ… Ù†Ø´Ø± Ø¢Ù…Ù†
          
          ### ğŸ“¦ Ø§Ù„ØªØ«Ø¨ÙŠØª:
          1. Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ·
          2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù„ÙØ§Øª
          3. ØªØ´ØºÙŠÙ„ `MedicalLabAnalyzer.exe`
          
          ### ğŸ“‹ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª:
          - Windows 10/11 (64-bit)
          - .NET 8.0 Runtime
          
          ### ğŸ”§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠÙŠÙ†:
          - **admin/admin** - Ù…Ø¯ÙŠØ±
          - **lab/123** - ÙÙ†ÙŠ Ù…Ø®ØªØ¨Ø±
          - **reception/123** - Ù…Ø³ØªÙ‚Ø¨Ù„
          
          ### ğŸ“ Ø§Ù„Ø¯Ø¹Ù…:
          - Ø±Ø§Ø¬Ø¹ `INSTALLATION_GUIDE.md` Ù„Ù„ØªÙØ§ØµÙŠÙ„
          - Ø±Ø§Ø¬Ø¹ `README.md` Ù„Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø´Ø§Ù…Ù„
          
          ---
          
          **MedicalLabAnalyzer** - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®ØªØ¨Ø± Ø·Ø¨ÙŠ Ù…ØªÙ‚Ø¯Ù… ğŸ¥âœ¨
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Notify production deployment
      run: |
        Write-Host "âœ… Production deployment completed!"
        Write-Host "Version: ${{ needs.build-and-package.outputs.version }}"
        Write-Host "Environment: production"
        Write-Host "Release created successfully!"

  health-check:
    needs: [deploy-to-staging, deploy-to-production]
    runs-on: windows-latest
    if: always()
    
    steps:
    - name: Health check staging
      if: needs.deploy-to-staging.result == 'success'
      run: |
        Write-Host "Performing health check on staging environment..."
        # Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ÙØ­Øµ ØµØ­Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        
    - name: Health check production
      if: needs.deploy-to-production.result == 'success'
      run: |
        Write-Host "Performing health check on production environment..."
        # Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ÙØ­Øµ ØµØ­Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬

  notify-deployment:
    needs: [deploy-to-staging, deploy-to-production, health-check]
    runs-on: windows-latest
    if: always()
    
    steps:
    - name: Deployment summary
      run: |
        Write-Host "=== Deployment Summary ==="
        Write-Host "Version: ${{ needs.build-and-package.outputs.version }}"
        Write-Host "Commit: ${{ github.sha }}"
        Write-Host "Branch: ${{ github.ref_name }}"
        
        if [ "${{ needs.deploy-to-staging.result }}" == "success" ]; then
          echo "âœ… Staging: Success"
        else
          echo "âŒ Staging: Failed"
        fi
        
        if [ "${{ needs.deploy-to-production.result }}" == "success" ]; then
          echo "âœ… Production: Success"
        else
          echo "âŒ Production: Failed"
        fi
        
        Write-Host "=========================="