name: Build and Deploy MedicalLabAnalyzer

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡'
        required: true
        default: 'release'
        type: choice
        options:
        - debug
        - release
      create_zip:
        description: 'Ø¥Ù†Ø´Ø§Ø¡ ZIP'
        required: false
        default: true
        type: boolean
      run_tests:
        description: 'ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª'
        required: false
        default: true
        type: boolean

env:
  DOTNET_VERSION: '8.0.x'
  SOLUTION_FILE: 'MedicalLabAnalyzer.sln'
  PROJECT_FILE: 'MedicalLabAnalyzer.csproj'

jobs:
  build-and-test:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}

    - name: Build solution
      run: |
        dotnet build ${{ env.SOLUTION_FILE }} --configuration ${{ github.event.inputs.build_type || 'Release' }} --no-restore
        dotnet build ${{ env.SOLUTION_FILE }} --configuration ${{ github.event.inputs.build_type || 'Release' }} --no-restore --verbosity detailed

    - name: Run tests
      if: ${{ github.event.inputs.run_tests != false }}
      run: dotnet test ${{ env.SOLUTION_FILE }} --configuration ${{ github.event.inputs.build_type || 'Release' }} --no-build --verbosity normal --collect:"XPlat Code Coverage" --results-directory ./coverage

    - name: Upload test results
      if: ${{ github.event.inputs.run_tests != false }}
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: coverage/

    - name: Publish application
      run: |
        dotnet publish ${{ env.PROJECT_FILE }} --configuration ${{ github.event.inputs.build_type || 'Release' }} --runtime win-x64 --self-contained true --output publish/win-x64 --verbosity normal

    - name: Create deployment package
      if: ${{ github.event.inputs.create_zip != false }}
      run: |
        $packageName = "MedicalLabAnalyzer_v${{ github.run_number }}_win-x64"
        $distPath = "dist"
        $publishPath = "publish/win-x64"
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹
        New-Item -ItemType Directory -Path "$distPath/$packageName" -Force
        
        # Ù†Ø³Ø® Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©
        Copy-Item -Path "$publishPath/*" -Destination "$distPath/$packageName/" -Recurse -Force
        
        # Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©
        Copy-Item -Path "README.md" -Destination "$distPath/$packageName/" -Force
        Copy-Item -Path "INSTALLATION_GUIDE.md" -Destination "$distPath/$packageName/" -Force
        Copy-Item -Path "QUICK_START.md" -Destination "$distPath/$packageName/" -Force
        Copy-Item -Path "CHANGELOG.txt" -Destination "$distPath/$packageName/" -Force
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù appsettings.json
        @"
{
  "ConnectionStrings": {
    "DefaultConnection": "Data Source=Database/medical_lab.db"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft": "Warning",
      "Microsoft.Hosting.Lifetime": "Information"
    }
  },
  "AllowedHosts": "*",
  "Database": {
    "AutoMigrate": true,
    "SeedData": true
  },
  "Reports": {
    "OutputPath": "Reports/GeneratedReports",
    "ArchivePath": "Reports/Archive",
    "TemplatePath": "Reports/Templates"
  },
  "Security": {
    "JwtSecret": "your-super-secret-jwt-key-change-in-production",
    "JwtExpirationHours": 24
  }
}
"@ | Out-File -FilePath "$distPath/$packageName/appsettings.json" -Encoding UTF8
        
        # Ø¥Ù†Ø´Ø§Ø¡ ZIP
        Compress-Archive -Path "$distPath/$packageName/*" -DestinationPath "$distPath/${packageName}.zip" -Force
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±
        @"
MedicalLabAnalyzer v${{ github.run_number }}
Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
Commit: ${{ github.sha }}
Branch: ${{ github.ref_name }}
"@ | Out-File -FilePath "$distPath/${packageName}_info.txt" -Encoding UTF8

    - name: Upload deployment package
      if: ${{ github.event.inputs.create_zip != false }}
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: dist/*.zip

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: publish/win-x64/

  create-release:
    needs: build-and-test
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download deployment package
      uses: actions/download-artifact@v4
      with:
        name: deployment-package
        path: dist/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: dist/*.zip
        draft: false
        prerelease: false
        generate_release_notes: true
        title: MedicalLabAnalyzer ${{ github.ref_name }}
        body: |
          ## ğŸ‰ MedicalLabAnalyzer ${{ github.ref_name }}
          
          ### ğŸ“¦ Ù…Ø§ Ù‡Ùˆ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±:
          - âœ… ØªØ­Ø³ÙŠÙ†Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø¯Ø§Ø¡
          - âœ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
          - âœ… ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
          - âœ… ØªØ­Ø³ÙŠÙ†Ø§Øª ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
          
          ### ğŸš€ Ø§Ù„ØªØ«Ø¨ÙŠØª:
          1. Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ·
          2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù„ÙØ§Øª
          3. ØªØ´ØºÙŠÙ„ `MedicalLabAnalyzer.exe`
          
          ### ğŸ“‹ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª:
          - Windows 10/11 (64-bit)
          - .NET 8.0 Runtime
          
          ### ğŸ”§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠÙŠÙ†:
          - **admin/admin** - Ù…Ø¯ÙŠØ±
          - **lab/123** - ÙÙ†ÙŠ Ù…Ø®ØªØ¨Ø±
          - **reception/123** - Ù…Ø³ØªÙ‚Ø¨Ù„
          
          ### ğŸ“ Ø§Ù„Ø¯Ø¹Ù…:
          - Ø±Ø§Ø¬Ø¹ `INSTALLATION_GUIDE.md` Ù„Ù„ØªÙØ§ØµÙŠÙ„
          - Ø±Ø§Ø¬Ø¹ `README.md` Ù„Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø´Ø§Ù…Ù„
          
          ---
          
          **MedicalLabAnalyzer** - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®ØªØ¨Ø± Ø·Ø¨ÙŠ Ù…ØªÙ‚Ø¯Ù… ğŸ¥âœ¨
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-to-staging:
    needs: build-and-test
    runs-on: windows-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: staging/

    - name: Deploy to staging
      run: |
        Write-Host "Deploying to staging environment..."
        # Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù†Ø´Ø± Ø¥Ù„Ù‰ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        # Ù…Ø«Ø§Ù„: Ù†Ø³Ø® Ø§Ù„Ù…Ù„ÙØ§Øª Ø¥Ù„Ù‰ Ø®Ø§Ø¯Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±

    - name: Notify deployment
      run: |
        Write-Host "Staging deployment completed successfully!"
        Write-Host "Build Number: ${{ github.run_number }}"
        Write-Host "Commit: ${{ github.sha }}"

  security-scan:
    runs-on: windows-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Security scan
      run: |
        Write-Host "Running security scan..."
        # Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø£Ø¯ÙˆØ§Øª ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†
        # Ù…Ø«Ø§Ù„: dotnet list package --vulnerable

    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security-report.txt